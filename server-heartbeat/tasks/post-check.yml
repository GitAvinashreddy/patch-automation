---
- name: initialize post checks
  copy:
    dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/post-log"
    content: "############################## TAKING POSTCHECK  LOGS & COMPARING WITH PRECHECK  ########################################"
  tags:
    - post
- name: verify hostname
  block:
    - name: read hostname
      shell: "hostname"
      register: hostname_post
    - name: set fact hostname
      set_fact:
        results_post: '{{ results_post|combine({"hostname-post": " ".join(hostname_post.stdout_lines)|quote }) }}'
    - name: log hostname
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/hostname-post"
        content: "{{ hostname_post.stdout }}"
  tags:
    - post
- name: get uname output
  block:
    - name: retrieve dist data
      shell: "uname -r"
      register: uname_post
    - name:
      set_fact:
        results_post: '{{ results_post|combine({"uname-post": " ".join(uname_post.stdout_lines)|quote}) }}'
    - name: copy uname output
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/uname-post"
        content: "{{ uname_post.stdout }}"
  tags:
    - post
- name: read syscfg network file
  block:
    - name: get network syscfg
      shell: "cat /etc/sysconfig/network"
      ignore_errors: true
      register: syscfg_net_post
    - name: set fact syscfg
      set_fact:
        results_post: '{{ results_post|combine({"syscfg_net-post": " ".join(syscfg_net_post.stdout_lines)|quote}) }}'
    - name: backup syscfg network file
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/sys-network-post"
        content: "{{ syscfg_net_post.stdout }}"
  tags:
    - post
- name: retrieve routes info
  block:
    - name: get route output
      shell: "route -n | sort"
      register: routes_post
    - name: set fact routes
      set_fact:
        results_post: '{{ results_post|combine({"route-post": " ".join(routes_post.stdout_lines)|quote}) }}'
    - name: log routes data
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/route-post"
        content: "{{ routes_post.stdout }}"
  tags:
    - post
- name: read mounts info
  block:
    - name: get mount cmd output
      shell: "mount -l | sort"
      register: mounts_post
    - name: set fact mounts
      set_fact:
        results_post: '{{ results_post|combine({"mount-post": " ".join(mounts_post.stdout_lines)|quote}) }}'
    - name: write mounts info
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/pre/mount-l-post"
        content: "{{ mounts_post.stdout }}"
  tags:
    - post
- name: list filesystems disks
  block:
    - name: read df output
      shell: "df -hP | awk '{print $1 \" \" $6}' | sort"
      register: df_post
    - name: set fact df
      set_fact:
        results_post: '{{ results_post|combine({"df-post": " ".join(df_post.stdout_lines)|quote}) }}'
    - name: dump fs disks info
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/df-post"
        content: "{{ df_post.stdout }}"
  tags:
    - post
- name: retrieve fdisk output
  block:
    - name: get partitions info
      shell: "fdisk -l"
      register: fdisk_post
    - name: set fact fdisk
      set_fact:
        results_post: '{{ results_post|combine({"fdisk-post": " ".join(fdisk_post.stdout_lines)|quote }) }}'
    - name: write fdisk info
      copy:
        dest: '{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/fdisk-l-post'
        content: "{{ fdisk_post }}"
  tags:
    - post
- name: get lsblk info
  block:
    - name: fetch block devices data
      shell: "lsblk"
      register: lsblk_post
    - name: set fact lsblk
      set_fact:
        results_post: '{{ results_post|combine({"lsblk-post": " ".join(lsblk_post.stdout_lines|quote)}) }}'
    - name: dump block devices data
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/lsblk-post"
        content: "{{ lsblk_post.stdout }}"
  tags:
    - post
- name:
  block:
    - name: read lv cmd output
      shell: "lvs | sort "
      register: lvs_post
    - name:
      set_fact:
        results_post: '{{ results_post|combine({"lvs-post": " ".join(lvs_post.stdout_lines)|quote }) }}'
    - name: write lvs command output
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/lvs-post"
        content: "{{ lvs_post.stdout }}"
  tags:
    - post
- name: see itables systemctl services status
  block:
    - name: check iptables service enablence\\
      shell: "service iptables status"
      ignore_errors: true
      register: iptables_post
    - name: set fact iptables
      set_fact:
        results_post: '{{ results_post|combine({"iptables-post": " ".join(iptables_post.stdout_lines)|quote }) }}'
    - name: read/write iptables>
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/iptables-post"
        content: "{{ iptables_post.stdout }}"
  tags:
    - post
- name: grab firewalld service status
  block:
    - name: check status firewalld service
      shell: "service firewalld status"
      ignore_errors: true
      register: firewalld_post
    - name: set fact firewalld
      set_fact:
        results_post: '{{ results_post|combine({"firewalld-post": " ".join(firewalld.stdout_lines)|quote }) }}'
    - name: write firewalld service status
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/firewall-post"
        content: "{{ firewalld_post.stdout }}"
  tags:
    - post
- name: fetch sssd systemctl status service
  block:
    - name: get sssd service status
      shell: 'systemctl status sssd | grep -i active'
      ignore_errors: true
      register: sssd_post
    - name: set fact sssd
      set_fact:
        results_post: '{{ results_post|combine({"sssd-post": " ".join(sssd_post.stdout_lines)|quote}) }}'
    - name: write sssd service status
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/sssd-post"
        content: "{{ sssd_post.stdout }}"
  tags:
    - post
- name: retrieve Memory/CPU info
  block:
    - name: read CPU data
      shell: "echo -e  \"Total CPU: `cat /proc/cpuinfo  | grep \"processor\" | wc -l` Memory: `cat /proc/meminfo | grep -i memtotal | awk '{print $2}'` kb before recycle\""
      register: cpu_post
    - name: set fact Memory/CPU
      set_fact:
        results_post: '{{ results_post|combine({"cpu-post": " ".join(cpu_post.stdout_lines)|quote }) }}'
    - name: dump CPU data
      lineinfile:
        path: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/post-log"
        line: "{{ cpu_post.stdout }}"
  tags:
    - post
- name: get internet interfaces info
  block:
    - name: retrieve ip addr output
      shell: "ip addr | awk '/^[0-9]+:/ { sub(/:/,\"\",$2); iface=$2 } /^[[:space:]]*inet / { split($2, a, \"/\"); print iface\" : \"a[1] }' | sort"
      register: ipa_post
    - name: set fact ip address
      set_fact:
        results_post: '{{ results_post|combine({"ipaddress-post": " ".join(ipa_post.stdout_lines)|quote }) }}'
    - name: dump ip addr info
      copy:
        dest: "{{ remote_logs_path }}/{{ ansible_ssh_host }}/post/ips-post"
        content: "{{ ipa_post.stdout }}"
  tags:
    - post
